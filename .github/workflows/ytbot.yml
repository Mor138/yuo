name: YouTube Shorts Bot

on:
  workflow_dispatch:          # –∑–∞–ø—É—Å–∫ –≤-—Ä—É—á–Ω—É—é
  schedule:
    - cron: '0 12 * * *'      # –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 12-00 UTC

jobs:
  run-bot:
    runs-on: ubuntu-latest

    steps:
      # ---------- 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π ----------
      - name: üì• Checkout
        uses: actions/checkout@v4

      # ---------- 2. –°—Ç–∞–≤–∏–º Python ----------
      - name: üêç Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # ---------- 3. –ö—ç—à–∏—Ä—É–µ–º pip-–ø–∞–∫–µ—Ç—ã ----------
      - name: üíæ Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      # ---------- 4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ ----------
      - name: üì¶ Install deps + —Ñ–∏–∫—Å MoviePy
        run: |
          python -m venv venv
          source venv/bin/activate
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –±–∞–≥ MoviePy 2.x ‚Äî —Å—Ç–∞–≤–∏–º —Å—Ç–∞–±–∏–ª—å–Ω—É—é 1.0.3
          pip install --force-reinstall "moviepy==1.0.3"

      # ---------- 5. –î–µ–∫–æ–¥–∏—Ä—É–µ–º client_secret.json ----------
      - name: üîê Decode Google client secret
        env:
          GOOGLE_CLIENT_SECRET_JSON: ${{ secrets.GOOGLE_CLIENT_SECRET_JSON }}
        run: |
          echo "$GOOGLE_CLIENT_SECRET_JSON" > client_secret.b64
          if grep -q '"' client_secret.b64; then
            mv client_secret.b64 client_secret.json         # —É–∂–µ JSON
          else
            base64 -d client_secret.b64 > client_secret.json
          fi

      # ---------- 6. –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ ----------
      - name: ü§ñ Run yt_shorts_bot.py
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          GOOGLE_CLIENT_SECRET: file://client_secret.json
        run: |
          source venv/bin/activate
          python yt_shorts_bot.py

      # ---------- 7. –ö–æ–º–º–∏—Ç–∏–º history/* –µ—Å–ª–∏ –ø–æ—è–≤–∏–ª—Å—è –Ω–æ–≤—ã–π —Ñ–∞–π–ª ----------
      - name: üìú Commit history
        if: success()
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add history/*.json || true
          if git diff --cached --quiet; then
            echo "No new history to commit"
          else
            git commit -m "Add history log" && git push
          fi
