name: YouTube Shorts Bot

on:
  workflow_dispatch:
  schedule:
    - cron: '0 12 * * *'   # раз в сутки в 12:00 UTC

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with: { python-version: '3.10' }

      - name: Install deps (c фиксом moviepy)
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          # ➜ переустанавливаем рабочую версию moviepy
          pip install --force-reinstall "moviepy==1.0.3"

      - name: Decode Google client secret
        env: { GOOGLE_CLIENT_SECRET_JSON: ${{ secrets.GOOGLE_CLIENT_SECRET_JSON }} }
        run: |
          echo "$GOOGLE_CLIENT_SECRET_JSON" > client_secret.b64
          if grep -q '"' client_secret.b64; then mv client_secret.b64 client_secret.json
          else base64 -d client_secret.b64 > client_secret.json; fi

      - name: Run bot
        env:
          DEEPSEEK_API_KEY:   ${{ secrets.DEEPSEEK_API_KEY }}
          GOOGLE_CLIENT_SECRET: file://client_secret.json
        run: |
          source venv/bin/activate
          python yt_shorts_bot.py
