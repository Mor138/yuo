name: YouTube Shorts Bot

on:
  schedule:
    - cron: '0 12 * * *'  # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 12:00 UTC
  workflow_dispatch:       # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

jobs:
  run-bot:
    runs-on: ubuntu-latest

    steps:
      - name: üõéÔ∏è Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v3

      - name: üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: üíæ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ pip-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: üîê –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ client_secret.json
        run: |
          echo "$GOOGLE_CLIENT_SECRET_JSON" > client_secret.b64
          if grep -q '"' client_secret.b64; then
            mv client_secret.b64 client_secret.json
          else
            base64 -d client_secret.b64 > client_secret.json
          fi
        env:
          GOOGLE_CLIENT_SECRET_JSON: ${{ secrets.GOOGLE_CLIENT_SECRET_JSON }}

      - name: ü§ñ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_CLIENT_SECRET: file://client_secret.json
        run: |
          python yt_shorts_bot.py

      - name: üíæ –ö–æ–º–º–∏—Ç –∏—Å—Ç–æ—Ä–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è)
        if: success()
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add history/*.json || true
          if git diff --cached --quiet; then
            echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          else
            git commit -m "üìú Add history" && git push
          fi
